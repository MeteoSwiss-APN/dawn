#include "dawn/Optimizer/Options.h"
#include "dawn/Compiler/Driver.h"

#include "dawn/CodeGen/Driver.h"
#include "dawn/CodeGen/Options.h"

#include "dawn/SIR/SIR.h"
#include "dawn/IIR/StencilInstantiation.h"

#include "dawn/Serialization/SIRSerializer.h"
#include "dawn/Serialization/IIRSerializer.h"

#include <pybind11/pybind11.h>
#include <pybind11/stl.h>

#include <sstream>
#include <string>

namespace py = ::pybind11;

PYBIND11_MODULE(_dawn4py, m) {
  m.doc() = "Dawn DSL toolchain"; // optional module docstring

  // Enumerations
  {{ PassGroup }}
  {{ CodeGenBackend }}

  // Options structs
  {{ OptimizerOptions }}
  {{ CodeGenOptions }}

  m.def("defaultPassGroups", &dawn::defaultPassGroupsStrings,
        "Return a list of default optimizer pass groups");

  m.def("run_optimizer_sir", [](const std::string& sir,
                                const std::string& format,
                                const std::list<std::string>& groups,
                                const dawn::Options& options) {
      return dawn::run(sir, format, groups, options);
    },
    py::arg("sir"),
    py::arg("format") = "byte",
    py::arg("groups") = std::list<std::string>(),
    py::arg("options") = dawn::Options()
  );

  m.def("run_optimizer_iir", [](const std::map<std::string, std::string>& stencilInstantiationMap,
                                const std::string& format,
                                const std::list<std::string>& groups,
                                const dawn::Options& options) {
      return dawn::run(stencilInstantiationMap, format, groups, options);
    },
    py::arg("stencil_instantiation_map"),
    py::arg("format") = "byte",
    py::arg("groups") = std::list<std::string>(),
    py::arg("options") = dawn::Options()
  );

  m.def("run_codegen", [](const std::map<std::string, std::string>& stencilInstantiationMap,
                          const std::string& format,
                          const std::string& backend,
                          const dawn::codegen::Options& options) {
      return dawn::codegen::run(stencilInstantiationMap, format, backend, options);
    },
    py::arg("stencil_instantiation_map"),
    py::arg("format") = "byte",
    py::arg("backend") = "gridtools",
    py::arg("options") = dawn::codegen::Options()
  );

  m.def("compile_sir", [](const std::string& sir,
                          const std::string& format,
                          const std::list<std::string>& passGroups,
                          const dawn::Options& optimizerOptions,
                          const std::string& backend,
                          const dawn::codegen::Options& codegenOptions) {
      return dawn::compile(sir, format, passGroups, optimizerOptions, backend, codegenOptions);
    },
    "Compile the provided SIR",
    py::arg("sir"),
    py::arg("format") = "byte",
    py::arg("optimizer_groups") = dawn::defaultPassGroupsStrings(),
    py::arg("optimizer_options") = dawn::Options(),
    py::arg("codegen_backend") = "gridtools",
    py::arg("codegen_options") = dawn::codegen::Options()
  );
}
